---
title: "Problem Set #3 - DATASCI W241"
author: "Greg Ceccarelli"
date: "October 30, 2015"
output: pdf_document
---

## Problem 1.

```{r}
library(dplyr)
library(stargazer)

setwd("/Users/ceccarelli/MIDS/DATASCI_W241/Assignments/Problem Set 3/")
#clear variables
rm( list = ls() )
#read in tabular data
d <- read.csv("broockman_green_anon_pooled_fb_users_only.csv", sep=",", header = TRUE)

##Begin Problem 1 A##
#create new data frame only containing Study 1 data
d.s1 <- filter(d, grepl("Study 1",cluster)) %>%
  na.omit()

#simple plot 
plot(x = d.s1$treat_ad, y=d.s1$name_recall)

#regress treatment against name recall
mod1_summary <- summary(lm(name_recall ~ treat_ad,d.s1))

#review line slope
abline(lm(name_recall ~ treat_ad,d))

#pull out data for confidence interval creation

ate <- mod1_summary$coefficients[2,1]
se <- mod1_summary$coefficients[2,2]

##End Problem 1 a. 
ci <- c(ate-1.96 *se, ate+1.96*se)

##Begin Problem 1 c.

#initialize clustered standard errors function
cl <- function(fm, cluster){
  require(sandwich, quietly = TRUE)
	require(lmtest, quietly = TRUE)
	M <- length(unique(cluster))
	N <- length(cluster)
	K <- fm$rank
	dfc <- (M/(M-1))*((N-1)/(N-K))
	uj <- apply(estfun(fm),2, function(x) tapply(x, cluster, sum));
	vcovCL <- dfc*sandwich(fm, meat=crossprod(uj)/N)
	coeftest(fm, vcovCL)
}

#make sure to set cluster variable as a factor
d.s1$cluster <- factor(as.character(d.s1$cluster))

#run standard errors
c.se <- cl(lm(name_recall ~ treat_ad,d.s1), d.s1$cluster)

c.se.ate <- c.se[2,1]
c.se.se <- c.se[2,2]

##End Problem 1 c. 
c.se.ci <- c(c.se.ate -1.96 *c.se.se, c.se.ate+1.96*c.se.se)

#stargazer(cl(lm(name_recall ~ treat_ad,d.s1), d.s1$cluster), lm(name_recall ~ treat_ad,d.s1), type = "text")

#create new data frame only containing Study 2 data and removing NAs
d.s2 <- filter(d, grepl("Study 2",cluster)) %>%
  na.omit()

d.s2$cluster <- factor(as.character(d.s2$cluster))


#run standard errors
c2.se <- cl(lm(name_recall ~ treat_ad, d.s2), d.s2$cluster)

c2.se.ate <- c2.se[2,1]
c2.se.se <- c2.se[2,2]


##End Problem 1 d. 
c2.se.ci <- c(c2.se.ate -1.96 *c2.se.se, c2.se.ate+1.96*c2.se.se)

##Begin Problem 1 e.

#create new data frame only containing Study 2 data and removing NAs
d.all <- d %>%
  na.omit()

d.all <- mutate(d.all, cluster =factor(as.character(d.all$cluster)))

#run standard errors
c3.se <- cl(lm(name_recall ~ treat_ad, d.all), d.all$cluster)

c3.se.ate <- c3.se[2,1]
c3.se.pvalue <- c3.se[2,4]

##End Problem 1 e. 



```


a. Using regression without clustered standard errors (that is, ignoring the clustered assignment), compute a confidence interval for the effect of the ad on candidate name recognition in Study 1 only (the dependent variable is “name_recall”).

```{r}
ci
```


b. What are the clusters in Broockman and Green’s study? Why might taking clustering into account increase the standard errors?

In Study 1, 32,029 voters who were then assigned to 1,220 clusters across 18 age range, the 34 towns in the candidates’ district, and 2 genders. 

Clustering can increase standard errors when cluster-level noise is large or the number of clusters are small (and noise is large)


c. Now repeat part (a), but taking clustering into account. That is, compute a confidence interval for the effect of the ad on candidate name recognition in Study 1, but now correctly accounting for the clustered nature of the treatment assignment.

```{r}
c.se.ci
```

d. Repeat part (c), but now for Study 2 only.

```{r}
c2.se.ci
```

e. Repeat part (c), but using the entire sample from both studies. Do not take into account which study the data is from (more on this in a moment), but just pool the data and run one omnibus regression. What is the treatment effect estimate and associated p-value?

```{r}
cat(" ATE = ", c3.se.ate, " pvalue = ", c3.se.pvalue)
```



